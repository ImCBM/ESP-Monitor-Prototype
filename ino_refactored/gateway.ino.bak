/*
 * ESP1 Gateway - Receive Only
 * 
 * Simple ESP-NOW to USB Serial bridge
 * Receives messages from ESP2 peers and forwards to monitor
 * No constant pinging - only outputs when messages are received
 * 
 * Hardware: ESP32 connected via USB to PC/laptop
 */

#include <WiFi.h>
#include <esp_now.h>
#include <esp_wifi.h>
#include <ArduinoJson.h>

// ============ GATEWAY CONFIGURATION ============
const char* DEVICE_ID = "ESP1_GATEWAY";
const char* DEVICE_TYPE = "GATEWAY";
const char* GATEWAY_VERSION = "1.0.0";
const char* SHARED_KEY = "ndrrmc_441";  // Authentication key

// ============ STATISTICS ============
int messageCount = 0;
int validMessages = 0;
int invalidMessages = 0;

// ============ SETUP ============
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n================================");
  Serial.println("ESP1 Gateway - Receive Only");
  Serial.println("================================");
  Serial.printf("Device ID: %s\n", DEVICE_ID);
  Serial.printf("Version: %s\n", GATEWAY_VERSION);
  Serial.printf("Shared Key: %s\n", SHARED_KEY);
  Serial.println("================================\n");
  
  // Initialize ESP-NOW
  initESPNow();
  
  Serial.println("ðŸš€ Gateway Ready - Listening for ESP2 messages...\n");
}

// ============ MAIN LOOP ============
void loop() {
  // Nothing to do - all processing happens in callback
  delay(100);
}

// ============ ESP-NOW INITIALIZATION ============
void initESPNow() {
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  
  Serial.printf("MAC Address: %s\n", WiFi.macAddress().c_str());
  
  if (esp_now_init() != ESP_OK) {
    Serial.println("âŒ ESP-NOW init failed");
    ESP.restart();
    return;
  }
  
  Serial.println("âœ“ ESP-NOW initialized");
  
  // Register receive callback
  esp_now_register_recv_cb(onDataReceived);
  
  // Set channel
  esp_wifi_set_promiscuous(true);
  esp_wifi_set_channel(1, WIFI_SECOND_CHAN_NONE);
  esp_wifi_set_promiscuous(false);
  
  Serial.println("âœ“ Listening on channel 1");
}

// ============ ESP-NOW RECEIVE CALLBACK ============
void onDataReceived(const esp_now_recv_info_t *info, const uint8_t *data, int len) {
  messageCount++;
  
  // Get sender MAC
  char macStr[18];
  snprintf(macStr, sizeof(macStr), "%02X:%02X:%02X:%02X:%02X:%02X",
           info->src_addr[0], info->src_addr[1], info->src_addr[2],
           info->src_addr[3], info->src_addr[4], info->src_addr[5]);
  
  // Get RSSI
  int rssi = info->rx_ctrl ? info->rx_ctrl->rssi : 0;
  
  // Convert data to string
  String receivedData = "";
  for (int i = 0; i < len; i++) {
    receivedData += (char)data[i];
  }
  
  // Parse JSON
  JsonDocument doc;
  DeserializationError error = deserializeJson(doc, receivedData);
  
  if (error) {
    invalidMessages++;
    Serial.printf("âŒ Invalid JSON from %s\n", macStr);
    return;
  }
  
  // Validate shared key
  String receivedKey = doc["shared_key"] | "";
  if (receivedKey != SHARED_KEY) {
    invalidMessages++;
    Serial.printf("âŒ Invalid key from %s: %s\n", macStr, receivedKey.c_str());
    return;
  }
  
  validMessages++;
  
  // Extract message info
  String messageType = doc["message_type"] | "unknown";
  String senderDevice = "unknown";
  String senderOwner = "unknown";
  
  if (doc.containsKey("source_device")) {
    senderDevice = doc["source_device"]["device_id"] | "unknown";
    senderOwner = doc["source_device"]["owner"] | "unknown";
  }
  
  // Create gateway output message
  JsonDocument output;
  output["gateway"] = DEVICE_ID;
  output["timestamp"] = millis();
  output["sender_mac"] = macStr;
  output["sender_device"] = senderDevice;
  output["sender_owner"] = senderOwner;
  output["message_type"] = messageType;
  output["rssi"] = rssi;
  output["message_number"] = messageCount;
  output["esp2_data"] = doc;  // Include full original message
  
  // Output to Serial (monitor reads this)
  String outputJson;
  serializeJson(output, outputJson);
  
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.printf("ðŸ“¨ Message #%d from %s (%s)\n", messageCount, senderDevice.c_str(), senderOwner.c_str());
  Serial.printf("   Type: %s | RSSI: %d dBm\n", messageType.c_str(), rssi);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println(outputJson);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}
